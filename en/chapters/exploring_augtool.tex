\chapter{Exploring augtool}

\index{augtool}
\index{augtool!commands|see{Commands}}

\chquote{
King Augeas’ fleecy flocks, good Sir,\\
feed not all of one pasture nor all upon one spot,\\
but some of them be tended along Heilisson,\\
others beside divine Alpheüs’ sacred stream,\\
others again by the fair vineyards of Buprasium,\\
and yet others, look you, hereabout;\\
and each flock hath his several fold builded.\\
}{-- Theocritus, Idyll 25.7}

While Augeas is a C library with bindings, it also provides a command-line tool called \verb!augtool!, which we will be using in the following examples. In chapter~\ref{chap:api}, we will see how to use the API and bindings directly.


\section{Parsing your System Configuration Files}

The first thing you might want to do is to see how Augeas sees your system configuration files. Fire up \verb!augtool!:

\consolecode/$ augtool/

This will give you an interactive shell which passes commands to Augeas. Augeas transforms your configuration files into a tree, which has two nodes at its root: \nolinkurl{/augeas} and \nolinkurl{/files}. The \nolinkurl{/augeas} node contains metadata, which we will be looking at later on, while \nolinkurl{/files} contains the representation of the files Augeas was able to parse. You can see these two nodes by typing \verb!ls /!:

\index{Commands!ls}

\begin{augtoolsh}
augtool> ls /
augeas/ = (none)
files/ = (none)
\end{augtoolsh}

What does that mean? We see the two nodes at the top of the Augeas tree, and we see that neither of them has a value. In the Augeas tree, each node can have children and a value associated with it.

\verb!ls! is an \verb!augtool! command which lists the children of the given node and gives their value (if any).

You can see which files (or directories containing files) were successfully parsed by Augeas in \nolinkurl{/etc} by typing \verb!ls /files/etc!:

\begin{augtoolsh}
augtool> ls /files/etc
nsswitch.conf/ = (none)
odbc.ini = (none)
passwd/ = (none)
ntp.conf/ = (none)
services/ = (none)
sysctl.conf/ = (none)
shells/ = (none)
samba/ = (none)
securetty/ = (none)
crypttab/ = (none)
...
\end{augtoolsh}

\index{Commands!print}

Let's inspect the contents of the first line of \nolinkurl{/etc/fstab} in the Augeas tree. We can use the \verb!print! command to inspect nodes and their values recursively:

\begin{augtoolsh}
augtool> print /files/etc/fstab/1
/files/etc/fstab/1
/files/etc/fstab/1/spec = "proc"
/files/etc/fstab/1/file = "/proc"
/files/etc/fstab/1/vfstype = "proc"
/files/etc/fstab/1/opt[1] = "nodev"
/files/etc/fstab/1/opt[2] = "noexec"
/files/etc/fstab/1/opt[3] = "nosuid"
/files/etc/fstab/1/dump = "0"
/files/etc/fstab/1/passno = "0"
\end{augtoolsh}

Each of the child nodes beneath the \verb!1! node refers to a part of a single line in the \nolinkurl{/etc/fstab} file. The filesystem options are further split into separate nodes under the \verb!opt! node so they can be managed individually.

What if we only wanted to find the \verb!opt! nodes of this first line? The \verb!match! command lets us find the nodes matching an expression:

\index{Commands!match}

\begin{augtoolsh}
augtool> match /files/etc/fstab/1/opt
/files/etc/fstab/1/opt[1] = nodev
/files/etc/fstab/1/opt[2] = noexec
/files/etc/fstab/1/opt[3] = nosuid
\end{augtoolsh}

Now, we might want to get the value of the single node matching an expression, and make sure that this node is unique. For example, if we want the value of the first \verb!opt! node of this first line, we could use the \verb!get! command:

\begin{augtoolsh}
augtool> get /files/etc/fstab/1/opt[1]
/files/etc/fstab/1/opt[1] = nodev
\end{augtoolsh}

\index{Commands!quit}

To leave the \verb!augtool! session, you can type \verb!quit! or \verb!^D!:

\augtoolshcode/augtool> quit/


\section{Using a Fakeroot}

It is often useful to play with \verb!augtool! when you want to understand the Augeas tree or try XPath expressions. However, you likely don't want to play with the files in your \nolinkurl{/etc} directory and take the risk of ruining your system. Augeas lets you set a fakeroot so that the files parsed and modified by Augeas are taken from this root instead of the \nolinkurl{/} directory of your system.

\index{augtool!options!--root} \index{Environment variables!\textsc{augeas\_root}}

In \verb!augtool! you can set this fakeroot by using the \verb!--root! option:

\begin{console}
$ mkdir -p myroot/etc
$ rsync -av /etc/ myroot/etc
$ augtool -r myroot
\end{console}

In general, you can also set the location of this fakeroot with the \verb!AUGEAS_ROOT! environment variable:

\begin{console}
$ export AUGEAS_ROOT="$(pwd)/myroot"
$ augtool
\end{console}

This option can also let you modify files inside a chroot for example.

\section{Modifying Files}

We have seen already how Augeas lets you parse your configuration files in a unified way. The Augeas tree is not only a parsing facility as Augeas exposes commands to modify the tree and save the changes to the original files.

The fakeroot option will be useful for us here, in order to modify the files without affecting the system. We will also use the \verb!--backup! option in \verb!augtool! so that the original files are preserved with a \verb!.augsave! extension.

\index{augtool!options!--backup} \index{augtool!options!--root} \index{Commands!rm} \index{Commands!quit} \index{Commands!save} \index{Environment variables!\textsc{augeas\_root}}

\begin{listing}
  \consolecode|$ augtool --backup --root myroot|
  \myinputminted{augtool-shell}{rm_fstab_opt.augtoolshell}
  \consolecode|$ diff -u myroot/etc/fstab myroot/etc/fstab.augsave|
  \myinputminted{diff}{fstab_opt.diff}
  \caption{Removing an option in fstab}
  \label{lst:rm_fstab_opt}
\end{listing}


In listing \ref{lst:rm_fstab_opt}, we change the filesystem options specified on the first line of \nolinkurl{/etc/fstab} by removing the third \verb!opt! node. The \verb!rm! command removes only the \verb!opt! node we specified, and the saved file has only this option removed. The rest of the file and even the rest of this line was left untouched, preserving the original formatting and layout.

\section{Preserving existing files}

\index{augtool!options!--backup} \index{augtool!options!--new} \index{Metadata!\slash{}augeas\slash{}save}

Augeas offers two options to preserve the existing files when saving the tree. In \verb!augtool!, these options can be triggered with the following flags:

\begin{itemize}
\item
  ---backup will save the original file with the extension .augsave and write the new file under the original file name;
\item
  ---new will save the modified file with a .augnew extension and leave the original file untouched.
\end{itemize}
These options actually modify the value of the \nolinkurl{/augeas/save} node in the Augeas tree\footnoteref{sec:save_node}.

\section{Locating nodes in files}

\label{sec:locating_nodes} \index{augtool!options!--span} \index{Flags!\textsc{aug\_enable\_span}}

The span metadata were added in Augeas 0.8.0. For performance reasons, they are not activated by default. This functionality can be activated by the \verb!AUG_ENABLE_SPAN! flag or the \verb!--span! flag in \verb!augtool!.

You can see if the \verb!span! functionality is activated in the current session by looking at the \nolinkurl{/augeas/span} node\footnoteref{sec:span_node}:

\index{Metadata!\slash{}augeas\slash{}span}

\begin{minted}[fontsize=\footnotesize]{augtool-shell}
augtool> get /augeas/span
/augeas/span = enable
\end{minted}

The data are then available via the \verb!span! command in \verb!augtool!:

\index{Commands!span}

\begin{listing}
  \begin{minted}[fontsize=\footnotesize]{console}
$ augtool --span
  \end{minted}
  \begin{minted}[fontsize=\footnotesize]{augtool-shell}
augtool> get /files/etc/ntp.conf/driftfile
/files/etc/ntp.conf/driftfile = /var/lib/ntp/ntp.drift
augtool> span /files/etc/ntp.conf/driftfile
/etc/ntp.conf label=(67:76) value=(77:99) span=(67,100)
augtool> quit
  \end{minted}
  \begin{minted}[fontsize=\footnotesize]{console}
$ head -c100 /etc/ntp.conf  | tail -c+67

driftfile /var/lib/ntp/ntp.drift
  \end{minted}
  \caption{Getting the position of a node with span}
  \label{lst:span_ntp}
\end{listing}

Listing \ref{lst:span_ntp} indicates that:

\begin{itemize}
\item
  The \verb!driftfile! label was found in the file between positions 67 and 76. This also means that \verb!driftfile! is a dynamic key, not a static label\footnoteref{chap:writing_lenses};
\item
  The value of the \verb!driftfile! node was found between positions 77 and 99 in the file;
\item
  The whole span of the node is between positions 67 and 100 in the file. The span is one character further than the value, since the \verb!\n! character is considered part of the lens matching the node, but is excluded from the value.
\end{itemize}
\section{Scripting with augtool}

\index{augtool!scripting}

In addition to running as an interactive shell, \verb!augtool! can take commands from the command line or STDIN:

\index{Commands!ls} \index{augtool!piping}

\begin{minted}[fontsize=\footnotesize]{console}
$ augtool ls /files
etc/ = (none)
$ echo "ls /files/" | augtool
etc/ = (none)
\end{minted}

This allows to write shell scripts that send commands to \verb!augtool!.

\index{Commands!set} \index{Commands!save} \index{augtool!piping}

\begin{listing}[H]
  \inputminted[linenos,frame=leftline,fontsize=\footnotesize]{bash}{../listings/augtool_wrap.sh}
  \caption{Piping commands to augtool in a bash script}
  \label{lst:augtool_wrap}
\end{listing}

\index{augtool!options!--autosave}

\begin{quote}
\info{The \texttt{--autosave} option in \texttt{augtool} allows you to ommit the \texttt{save} command.}
\end{quote}

Listing \ref{lst:augtool_wrap} shows an example of a bash script wrapping around \verb!augtool!. Lines 2 through 5 define the wrapping function \verb!do_augtool! which is then called on line 7. Commands are separated with \verb!\n! so they get passed line by line to \verb!augtool! through \verb!echo -e!.


\subsection{Using augtool as an interpreter}

\verb!augtool! can also take commands from a file:

\index{augtool!options!--file} \index{Commands!ls}

\begin{listing}
  \begin{minted}[fontsize=\footnotesize]{console}
$ cat commands.augtool
  \end{minted}
  \begin{minted}[fontsize=\footnotesize]{augtool}
ls "/files"
  \end{minted}
  \begin{minted}[fontsize=\footnotesize]{console}
$ augtool --file commands.augtool
  \end{minted}
  \begin{minted}[fontsize=\footnotesize]{augtool-shell}
etc/ = (none)
  \end{minted}
  \caption{\texttt{augtool} takes a command file as argument}
  \label{lst:augtool_file_arg}
\end{listing}

This allows to use \verb!augtool! as a script interpreter in a shebang and write self-executable \verb!augtool! scripts:

\begin{listing}
  \begin{minted}[fontsize=\footnotesize]{console}
$ cat commands.augtool
  \end{minted}
  \begin{minted}[fontsize=\footnotesize]{augtool}
#!/usr/bin/augtool -f
ls "/files"
  \end{minted}
  \begin{minted}[fontsize=\footnotesize]{console}
$ chmod +x commands.augtool
$ ./commands.augtool
  \end{minted}
  \begin{minted}[fontsize=\footnotesize]{augtool-shell}
etc/ = (none)
  \end{minted}
  \caption{Using \texttt{augtool} as an interpreter}
  \label{lst:augtool_interpreter}
\end{listing}

\subsection{Dropping into an interactive session}

When \verb!augtool! takes commands from the command line, STDIN or a file, it doesn't start an interactive session. If you wish to pass commands to \verb!augtool! for preprocessing and run an interactive command afterwards, you can use the \verb!--interactive! flag:

\index{augtool!piping} \index{Commands!get} \index{augtool!options!--interactive}

\begin{listing}
  \begin{minted}[fontsize=\footnotesize]{console}
$ echo "set /files/etc/hosts/1/canonical alice" | augtool --interactive
  \end{minted}
  \begin{minted}[fontsize=\footnotesize]{augtool-shell}
augtool> get /files/etc/hosts/1/canonical
/files/etc/hosts/1/canonical = alice
  \end{minted}
  \caption{Setting a single value in \texttt{augtool}}
  \label{lst:augtool_set_single}
\end{listing}

\begin{quote}
\info{The \texttt{--interactive} option only works for STDIN and file input.}

\end{quote}
This option also allows you to make scripts that set up an environment and drop you in an interactive shell:

\index{augtool!options!--file} \index{Commands!get} \index{Commands!set} \index{Commands!quit}

\begin{minted}[fontsize=\footnotesize]{console}
$ cat shell.augtool
#!/usr/bin/augtool -if
\end{minted}
\begin{minted}[fontsize=\footnotesize]{augtool}
set /files/etc/hosts/1/canonical alice
\end{minted}
\begin{minted}[fontsize=\footnotesize]{console}
$ chmod +x shell.augtool
$ ./shell.augtool
\end{minted}
\begin{minted}[fontsize=\footnotesize]{augtool-shell}
augtool> get /files/etc/hosts/1/canonical
/files/etc/hosts/1/canonical = alice
augtool> quit
\end{minted}

\begin{quote}
\info{Only concatenated short options can be used in shebangs, hence the use of \texttt{-if}.}
\end{quote}
